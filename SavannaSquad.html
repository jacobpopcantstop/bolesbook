<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9-1-1 Savanna Squad: Platinum Edition</title>
    
    <!-- React & DOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ROBUST ICON SYSTEM (Zero External Deps) ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2.5" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                dangerouslySetInnerHTML={{ __html: path }}
            />
        );

        const ICONS = {
            Heart: '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
            Shield: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>',
            Zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            Hourglass: '<path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/>', // Patience
            Activity: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>', // Regulation
            Star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
            Volume2: '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>',
            StopCircle: '<circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/>',
            Settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
            RefreshCw: '<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>',
            Brain: '<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/>',
            AlertTriangle: '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>',
            Skull: '<circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/>',
            Trophy: '<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>',
            ArrowRight: '<path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>',
            Mail: '<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>'
        };

        // --- TTS Helper ---
        const useTextToSpeech = () => {
            const [isSpeaking, setIsSpeaking] = useState(false);
            const synth = window.speechSynthesis;

            const speak = (text) => {
                if (synth.speaking) synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onend = () => setIsSpeaking(false);
                setIsSpeaking(true);
                synth.speak(utterance);
            };

            const stop = () => {
                synth.cancel();
                setIsSpeaking(false);
            };

            useEffect(() => () => synth.cancel(), []);
            return { speak, stop, isSpeaking };
        };

        // --- Character Component ---
        const SavannaAvatar = ({ type }) => {
            const colors = {
                buck: '#FCD34D', bobby: '#9CA3AF', athena: '#F59E0B',
                hen: '#FDE047', eddie: '#6B7280', chimney: '#D97706', maddie: '#E5E7EB'
            };
            const baseColor = colors[type] || '#9CA3AF';

            // Simplified SVG Paths for Characters
            const renderChar = () => {
                switch(type) {
                    case 'buck': return <g><circle cx="100" cy="100" r="90" fill="#B45309"/><circle cx="100" cy="100" r="60" fill={baseColor}/><circle cx="50" cy="60" r="15" fill={baseColor}/><circle cx="150" cy="60" r="15" fill={baseColor}/><ellipse cx="100" cy="120" rx="25" ry="20" fill="#FFF8DC"/><path d="M90 110 L110 110 L100 125 Z" fill="#000"/><circle cx="80" cy="90" r="6" fill="white"/><circle cx="80" cy="90" r="3" fill="black"/><circle cx="120" cy="90" r="6" fill="white"/><circle cx="120" cy="90" r="3" fill="black"/><path d="M60 45 L140 45 C 150 45, 150 35, 140 35 L60 35 C 50 35, 50 45, 60 45" fill="#EF4444"/><rect x="90" y="30" width="20" height="10" fill="#FCD34D"/></g>;
                    case 'bobby': return <g><path d="M20 60 Q 0 100 30 140 L 60 100 Z" fill={baseColor}/><path d="M180 60 Q 200 100 170 140 L 140 100 Z" fill={baseColor}/><circle cx="100" cy="90" r="60" fill={baseColor}/><path d="M90 130 Q 100 200 130 180" fill="none" stroke={baseColor} strokeWidth="20" strokeLinecap="round"/><circle cx="75" cy="80" r="5" fill="black"/><circle cx="125" cy="80" r="5" fill="black"/><path d="M60 40 L140 40 L130 20 L70 20 Z" fill="#1F2937"/><rect x="60" y="40" width="80" height="5" fill="#000"/></g>;
                    case 'athena': return <g><path d="M50 50 Q 100 20 150 50 L 140 150 Q 100 180 60 150 Z" fill={baseColor}/><circle cx="40" cy="60" r="15" fill={baseColor}/><circle cx="160" cy="60" r="15" fill={baseColor}/><path d="M70 90 Q 80 80 90 90" fill="none" stroke="black" strokeWidth="3"/><path d="M110 90 Q 120 80 130 90" fill="none" stroke="black" strokeWidth="3"/><circle cx="80" cy="95" r="4" fill="black"/><circle cx="120" cy="95" r="4" fill="black"/><path d="M90 120 L110 120 L100 135 Z" fill="black"/><path d="M50 40 L150 40 L140 20 L60 20 Z" fill="#1E3A8A"/><circle cx="100" cy="30" r="5" fill="#FCD34D"/></g>;
                    case 'hen': return <g><rect x="80" y="100" width="40" height="100" fill={baseColor}/><circle cx="90" cy="130" r="5" fill="#B45309" opacity="0.6"/><circle cx="110" cy="160" r="7" fill="#B45309" opacity="0.6"/><ellipse cx="100" cy="80" rx="35" ry="45" fill={baseColor}/><line x1="85" y1="40" x2="85" y2="15" stroke={baseColor} strokeWidth="6" strokeLinecap="round"/><circle cx="85" cy="15" r="5" fill="#B45309"/><line x1="115" y1="40" x2="115" y2="15" stroke={baseColor} strokeWidth="6" strokeLinecap="round"/><circle cx="115" cy="15" r="5" fill="#B45309"/><circle cx="85" cy="75" r="12" fill="none" stroke="black" strokeWidth="2"/><circle cx="115" cy="75" r="12" fill="none" stroke="black" strokeWidth="2"/><line x1="97" y1="75" x2="103" y2="75" stroke="black" strokeWidth="2"/><ellipse cx="100" cy="110" rx="20" ry="15" fill="#FEF3C7"/></g>;
                    case 'eddie': return <g><path d="M60 60 Q 100 40 140 60 L 150 140 Q 100 160 50 140 Z" fill={baseColor}/><path d="M100 80 Q 110 50 100 30 Q 90 50 100 80" fill="#E5E7EB" stroke="#4B5563"/><ellipse cx="50" cy="70" rx="10" ry="15" fill={baseColor}/><ellipse cx="150" cy="70" rx="10" ry="15" fill={baseColor}/><circle cx="80" cy="90" r="4" fill="black"/><circle cx="120" cy="90" r="4" fill="black"/><rect x="95" y="145" width="10" height="15" rx="2" fill="#9CA3AF"/></g>;
                    case 'chimney': return <g><ellipse cx="100" cy="120" rx="30" ry="60" fill={baseColor}/><circle cx="100" cy="70" r="25" fill="#FCD34D" opacity="0.9"/><ellipse cx="90" cy="70" rx="8" ry="12" fill="#78350F"/><ellipse cx="110" cy="70" rx="8" ry="12" fill="#78350F"/><circle cx="90" cy="70" r="3" fill="white"/><circle cx="110" cy="70" r="3" fill="white"/><path d="M70 70 Q 70 40 130 70" fill="none" stroke="#1F2937" strokeWidth="3"/><rect x="65" y="65" width="8" height="15" fill="#1F2937" rx="2"/><circle cx="115" cy="85" r="8" fill="#F472B6" opacity="0.8"/></g>;
                    case 'maddie': return <g><path d="M70 60 L 130 60 L 100 140 Z" fill={baseColor}/><path d="M80 60 Q 60 20 80 10" fill="none" stroke="#4B5563" strokeWidth="3"/><path d="M120 60 Q 140 20 120 10" fill="none" stroke="#4B5563" strokeWidth="3"/><ellipse cx="60" cy="70" rx="15" ry="5" fill={baseColor} transform="rotate(-20 60 70)"/><ellipse cx="140" cy="70" rx="15" ry="5" fill={baseColor} transform="rotate(20 140 70)"/><circle cx="90" cy="90" r="4" fill="black"/><circle cx="110" cy="90" r="4" fill="black"/></g>;
                    default: return null;
                }
            };

            return (
                <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-2xl filter transition-transform duration-700 hover:scale-105 animate-float">
                    {renderChar()}
                </svg>
            );
        };

        // --- Game Data (Enhanced Stats) ---
        const SCENES = {
            start: {
                id: 'start',
                bg: 'from-slate-900 to-black',
                character: null,
                text: "Welcome to the 118 Savanna Station! You are Ayshe. It's Day 1. The team is wild. Your goal: Make friends and stay cool.",
                speaker: "Narrator",
                choices: [{ text: "Start my shift", nextScene: 'lobby' }]
            },
            lobby: {
                id: 'lobby',
                bg: 'from-slate-800 to-slate-900',
                character: 'bobby',
                text: "Captain Bobby (The Elephant) is polishing the fire truck. \"Welcome, Ayshe. Ready to join the herd?\"",
                speaker: "Bobby (Elephant)",
                choices: [
                    { text: "\"Hi Captain! The truck looks great.\"", nextScene: 'level1_hub', stats: { prof: 1, emp: 1, pat: 0, reg: 0, assert: 1 }, feedback: "Professional, Kind, & Assertive. Starting with confidence builds rapport." },
                    { text: "\"I'm freaking out about the schedule!\"", nextScene: 'level1_hub', stats: { prof: -1, emp: 0, pat: 0, reg: -1, assert: 0 }, feedback: "Logistical Anxiety. This is an 'Unexpected' first greeting. Take a breath first." },
                    { text: "*Try to climb on his back*", nextScene: 'level1_hub', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Unexpected behavior. High energy, but wrong context. (-3 Professional)" },
                    { text: "\"It smells weird here.\"", nextScene: 'level1_hub', stats: { prof: -1, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Negativity. Complaining first thing sets a bad tone." }
                ]
            },
            level1_hub: {
                id: 'level1_hub',
                bg: 'from-slate-800 to-slate-900',
                character: null,
                text: "CHAPTER 1: The Watering Hole. Who needs a friend?",
                speaker: "Watering Hole",
                choices: [
                    { text: "Buck the Lion (Sad)", nextScene: 'gym_intro', targetChar: 'buck' },
                    { text: "Athena the Lioness (Angry)", nextScene: 'loft_intro', targetChar: 'athena' },
                    { text: "Hen the Giraffe (Busy)", nextScene: 'corner_intro', targetChar: 'hen' },
                    { text: "I'm done here. (Next Chapter)", nextScene: 'level2_transition', isExit: true }
                ]
            },
            gym_intro: {
                id: 'gym_intro',
                bg: 'from-gray-800 to-gray-900',
                character: 'buck',
                text: "Buck is pacing. \"I feel like I lost my roar on that last call.\"",
                speaker: "Buck (Lion)",
                choices: [
                    { text: "\"What happened? I'm listening.\"", nextScene: 'buck_success', stats: { prof: 0, emp: 1, pat: 1, reg: 0, assert: 0 }, feedback: "Patience & Empathy. Listening helps. (+1 Empathetic)" },
                    { text: "*Roar loudly* \"I am the alpha!\"", nextScene: 'buck_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! High energy at the wrong time. (+2 Assertive, -3 Professional)" },
                    { text: "\"My paws hurt.\"", nextScene: 'buck_fail', stats: { prof: 0, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Self-centered. Focus on him." },
                    { text: "\"Get over it, lion.\"", nextScene: 'buck_fail', stats: { prof: 0, emp: -3, pat: 0, reg: 0, assert: 1 }, feedback: "Dismissive. That hurts feelings. (+1 Assertive, -3 Empathetic)" }
                ]
            },
            buck_success: { id: 'buck_success', bg: 'from-yellow-900 to-slate-900', character: 'buck', mood: 'happy', text: "\"Thanks. Talking helps.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            buck_fail: { id: 'buck_fail', bg: 'from-gray-900 to-black', character: 'buck', text: "\"Uh... nevermind.\"", speaker: "Buck", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            loft_intro: {
                id: 'loft_intro',
                bg: 'from-orange-900 to-slate-900',
                character: 'athena',
                text: "\"That hyena detective ruined my crime scene!\"",
                speaker: "Athena (Lioness)",
                choices: [
                    { text: "*Listen quietly*", nextScene: 'athena_success', stats: { prof: 1, emp: 1, pat: 2, reg: 1, assert: 0 }, feedback: "Patience & Regulation. Good listening skills. (+0 Assertive)" },
                    { text: "\"Stop scratching things!\"", nextScene: 'athena_fail', stats: { prof: -2, emp: -2, pat: 0, reg: -1, assert: 1 }, feedback: "Bossy. Don't correct the Queen. (+1 Assertive, -2 Professional)" },
                    { text: "\"Let's eat him!\"", nextScene: 'athena_success', stats: { prof: -3, emp: 1, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! She likes the loyalty, but eating coworkers is against HR policy. (+2 Assertive, -3 Professional)" },
                    { text: "\"Hyenas are gross.\"", nextScene: 'athena_success', stats: { prof: -1, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Bonding. Shared enemy works, but it's not very professional. (-1 Professional)" }
                ]
            },
            athena_success: { id: 'athena_success', bg: 'from-blue-900 to-slate-900', character: 'athena', text: "\"Exactly. Thanks Ayshe.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            athena_fail: { id: 'athena_fail', bg: 'from-red-900 to-black', character: 'athena', text: "\"Go away, cub.\"", speaker: "Athena", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            corner_intro: {
                id: 'corner_intro',
                bg: 'from-indigo-900 to-slate-900',
                character: 'hen',
                text: "Hen is studying hard. \"Anatomy is so hard.\"",
                speaker: "Hen (Giraffe)",
                choices: [
                    { text: "*Offer snack break*", nextScene: 'hen_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Kindness. Gifts help relationship building. (+1 Empathetic)" },
                    { text: "\"I hate my notes!\"", nextScene: 'hen_fail', stats: { prof: -1, emp: -1, pat: 0, reg: -1, assert: 0 }, feedback: "Complaining. Don't make it about you right now." },
                    { text: "\"Can you see the future?\"", nextScene: 'hen_fail', stats: { prof: -2, emp: 0, pat: 0, reg: 0, assert: 0 }, feedback: "Crazy Cuckoo! Weird question." },
                    { text: "*Wait 5 minutes*", nextScene: 'hen_success', stats: { prof: 1, emp: 1, pat: 3, reg: 1, assert: 0 }, feedback: "High Patience! Great strategy." }
                ]
            },
            hen_success: { id: 'hen_success', bg: 'from-indigo-900 to-slate-900', character: 'hen', text: "\"You're sweet. Thanks.\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level1_hub' }] },
            hen_fail: { id: 'hen_fail', bg: 'from-slate-800 to-black', character: 'hen', text: "\"I need to focus.\"", speaker: "Hen", choices: [{ text: "Return", nextScene: 'level1_hub' }] },

            // Level 2
            level2_transition: { id: 'level2_transition', bg: 'from-red-900 to-slate-900', character: null, text: "ALARM! To the truck! Chapter 2: High Intensity.", speaker: "Narrator", choices: [{ text: "*Jump in*", nextScene: 'level2_hub' }] },
            level2_hub: {
                id: 'level2_hub',
                bg: 'from-red-900 to-slate-900',
                character: null,
                text: "CHAPTER 2: The Truck. It's loud and bumpy.",
                speaker: "Inside Truck",
                choices: [
                    { text: "Chimney (Joking)", nextScene: 'chimney_scene', targetChar: 'chimney' },
                    { text: "Eddie (Focused)", nextScene: 'eddie_scene', targetChar: 'eddie' },
                    { text: "Arrived! (Next Chapter)", nextScene: 'level3_transition', isExit: true }
                ]
            },
            chimney_scene: {
                id: 'chimney_scene',
                bg: 'from-red-900 to-slate-900',
                character: 'chimney',
                text: "\"Did you know a group of rhinos is called a crash?\"",
                speaker: "Chimney (Meerkat)",
                choices: [
                    { text: "\"Haha! Funny.\"", nextScene: 'chimney_success', stats: { prof: 0, emp: 1, pat: 0, reg: 1, assert: 0 }, feedback: "Social connection. Laughing helps." },
                    { text: "\"MY EARS HURT!\"", nextScene: 'chimney_fail', stats: { prof: -2, emp: -1, pat: -1, reg: -3, assert: 0 }, feedback: "Low Regulation. Don't scream." },
                    { text: "*Dig a hole*", nextScene: 'chimney_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Dangerous behavior." },
                    { text: "\"Actually it's a stubbornness.\"", nextScene: 'chimney_fail', stats: { prof: 0, emp: -1, pat: 0, reg: 0, assert: 1 }, feedback: "Fact Check. Kills the joke. (+1 Assertive, -1 Empathetic)" }
                ]
            },
            chimney_success: { id: 'chimney_success', bg: 'from-red-900 to-slate-900', character: 'chimney', text: "\"I knew you'd get it!\"", speaker: "Chimney", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },
            chimney_fail: { id: 'chimney_fail', bg: 'from-red-950 to-black', character: 'chimney', text: "\"Tough crowd.\"", speaker: "Chimney", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },
            eddie_scene: {
                id: 'eddie_scene',
                bg: 'from-red-900 to-slate-900',
                character: 'eddie',
                text: "Eddie is checking buckles silently.",
                speaker: "Eddie (Rhino)",
                choices: [
                    { text: "*Wait patiently*", nextScene: 'eddie_success', stats: { prof: 1, emp: 0, pat: 2, reg: 1, assert: 0 }, feedback: "Patience. Respecting his need for focus." },
                    { text: "\"Why is your skin thick?\"", nextScene: 'eddie_fail', stats: { prof: -1, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Rude question about appearance." },
                    { text: "*Wrestle him*", nextScene: 'eddie_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Not safe." },
                    { text: "\"I'm scared.\"", nextScene: 'eddie_success', stats: { prof: 0, emp: 1, pat: 0, reg: 1, assert: 0 }, feedback: "Vulnerability. It's okay to share." }
                ]
            },
            eddie_success: { id: 'eddie_success', bg: 'from-red-900 to-slate-900', character: 'eddie', text: "\"Stay close to me.\"", speaker: "Eddie", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },
            eddie_fail: { id: 'eddie_fail', bg: 'from-red-950 to-black', character: 'eddie', text: "\"Focus up.\"", speaker: "Eddie", choices: [{ text: "Back to seat", nextScene: 'level2_hub' }] },

            // Level 3
            level3_transition: { id: 'level3_transition', bg: 'from-slate-900 to-black', character: null, text: "Back at station. Nap time. Shhh.", speaker: "Narrator", choices: [{ text: "Enter Bunks", nextScene: 'level3_hub' }] },
            level3_hub: {
                id: 'level3_hub',
                bg: 'from-blue-950 to-slate-900',
                character: null,
                text: "CHAPTER 3: The Den. Check availability.",
                speaker: "Bunk Room",
                choices: [
                    { text: "Buck (Sleeping)", nextScene: 'l3_buck', targetChar: 'buck' },
                    { text: "Maddie (Phone)", nextScene: 'l3_maddie', targetChar: 'maddie' },
                    { text: "Eddie (Reading)", nextScene: 'l3_eddie', targetChar: 'eddie' },
                    { text: "Done. (Next Chapter)", nextScene: 'level4_transition', isExit: true }
                ]
            },
            l3_buck: {
                id: 'l3_buck',
                bg: 'from-blue-950 to-black',
                character: 'buck',
                text: "Zzzzz...",
                speaker: "Buck (Asleep)",
                choices: [
                    { text: "*Poke him* \"Wake up!\"", nextScene: 'l3_buck_fail', stats: { prof: -2, emp: -2, pat: -1, reg: -2, assert: 0 }, feedback: "Bad boundaries. Don't wake people." },
                    { text: "*Tiptoe away softly*", nextScene: 'l3_buck_success', stats: { prof: 1, emp: 1, pat: 1, reg: 1, assert: 0 }, feedback: "Respect. You noticed he wasn't available." },
                    { text: "*Cut his mane*", nextScene: 'l3_buck_fail', stats: { prof: -3, emp: -3, pat: 0, reg: -3, assert: 2 }, feedback: "Crazy Cuckoo! Never touch without asking." },
                    { text: "*Find something else*", nextScene: 'l3_buck_success', stats: { prof: 0, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Self-regulation. Handling boredom well." }
                ]
            },
            l3_buck_success: { id: 'l3_buck_success', bg: 'from-blue-950 to-black', character: null, text: "He sleeps on.", speaker: "Narrator", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_buck_fail: { id: 'l3_buck_fail', bg: 'from-red-900 to-black', character: 'buck', text: "\"ROAR?! WHO IS IT?!\"", speaker: "Buck", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_maddie: {
                id: 'l3_maddie',
                bg: 'from-blue-900 to-slate-900',
                character: 'maddie',
                text: "Maddie is whispering on the phone.",
                speaker: "Maddie (Gazelle)",
                choices: [
                    { text: "*Wait nearby*", nextScene: 'l3_maddie_success', stats: { prof: 1, emp: 1, pat: 3, reg: 1, assert: 0 }, feedback: "High Patience. Perfect waiting." },
                    { text: "\"LOOK AT ME!\"", nextScene: 'l3_maddie_fail', stats: { prof: -2, emp: -1, pat: -2, reg: -1, assert: 0 }, feedback: "Interruption. Wait your turn." },
                    { text: "\"Tell the President hi!\"", nextScene: 'l3_maddie_fail', stats: { prof: 0, emp: 0, pat: 0, reg: -1, assert: 1 }, feedback: "Crazy Cuckoo! Confusing." },
                    { text: "\"I'm hungry.\"", nextScene: 'l3_maddie_fail', stats: { prof: 0, emp: 0, pat: -1, reg: 0, assert: 0 }, feedback: "Impatience." }
                ]
            },
            l3_maddie_success: { id: 'l3_maddie_success', bg: 'from-blue-900 to-slate-900', character: 'maddie', text: "\"Thanks for waiting.\"", speaker: "Maddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_maddie_fail: { id: 'l3_maddie_fail', bg: 'from-blue-900 to-slate-900', character: 'maddie', text: "She walks away.", speaker: "Maddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_eddie: {
                id: 'l3_eddie',
                bg: 'from-blue-900 to-slate-900',
                character: 'eddie',
                text: "Eddie is reading.",
                speaker: "Eddie",
                choices: [
                    { text: "\"Can I sit here?\"", nextScene: 'l3_eddie_sit_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 1 }, feedback: "Polite Request. Good assertive skills." },
                    { text: "\"Books are dumb.\"", nextScene: 'l3_eddie_fail', stats: { prof: 0, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Insult. Not nice." },
                    { text: "*Eat the book pages*", nextScene: 'l3_eddie_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Destructive." },
                    { text: "\"Whatcha reading?\"", nextScene: 'l3_eddie_book_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Showing interest." }
                ]
            },
            l3_eddie_sit_success: { id: 'l3_eddie_sit_success', bg: 'from-blue-900 to-slate-900', character: 'eddie', text: "\"Sure. Just keep it down.\"", speaker: "Eddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_eddie_book_success: { id: 'l3_eddie_book_success', bg: 'from-blue-900 to-slate-900', character: 'eddie', text: "\"It's 'The Zen of Mud'. Surprisingly funny.\"", speaker: "Eddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },
            l3_eddie_fail: { id: 'l3_eddie_fail', bg: 'from-blue-900 to-slate-900', character: 'eddie', text: "He closes the book.", speaker: "Eddie", choices: [{ text: "Back to Bunks", nextScene: 'level3_hub' }] },

            // Level 4
            level4_transition: { id: 'level4_transition', bg: 'from-purple-900 to-slate-900', character: null, text: "Next Day. Operation: Elephant Surprise Birthday. Keep the secret!", speaker: "Narrator", choices: [{ text: "*Start Planning*", nextScene: 'level4_hub' }] },
            level4_hub: {
                id: 'level4_hub',
                bg: 'from-purple-900 to-slate-900',
                character: null,
                text: "CHAPTER 4: The Secret.",
                speaker: "Party Planning",
                choices: [
                    { text: "Athena (Cake)", nextScene: 'l4_athena', targetChar: 'athena' },
                    { text: "Buck (Loose Lips)", nextScene: 'l4_buck', targetChar: 'buck' },
                    { text: "Bobby (Birthday Boy)", nextScene: 'l4_bobby', targetChar: 'bobby' },
                    { text: "Party Time! (Next Chapter)", nextScene: 'level5_transition', isExit: true }
                ]
            },
            l4_athena: {
                id: 'l4_athena',
                bg: 'from-purple-900 to-slate-900',
                character: 'athena',
                text: "\"Hide this cake.\"",
                speaker: "Athena",
                choices: [
                    { text: "*Hide it behind the kale*", nextScene: 'l4_athena_success', stats: { prof: 1, emp: 1, pat: 0, reg: 1, assert: 1 }, feedback: "Problem Solving. Assertive & Smart." },
                    { text: "*Eat the cake now*", nextScene: 'l4_athena_fail', stats: { prof: -2, emp: 0, pat: -2, reg: -2, assert: 0 }, feedback: "Impulse Control. Wait! (-2 Prof)" },
                    { text: "*Throw the cake!*", nextScene: 'l4_athena_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Messy. (-3 Prof)" },
                    { text: "\"Okay.\"", nextScene: 'l4_athena_success', stats: { prof: 1, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Compliance. Good." }
                ]
            },
            l4_athena_success: { id: 'l4_athena_success', bg: 'from-purple-900 to-slate-900', character: 'athena', text: "\"Good work.\"", speaker: "Athena", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_athena_fail: { id: 'l4_athena_fail', bg: 'from-red-900 to-black', character: 'athena', text: "\"No!\"", speaker: "Athena", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_buck: {
                id: 'l4_buck',
                bg: 'from-purple-900 to-slate-900',
                character: 'buck',
                text: "\"I want to roar HAPPY BIRTHDAY!\"",
                speaker: "Buck",
                choices: [
                    { text: "\"Wait for the signal.\"", nextScene: 'l4_buck_success', stats: { prof: 1, emp: 0, pat: 2, reg: 1, assert: 1 }, feedback: "Leadership. Helping a friend wait. (+1 Assertive)" },
                    { text: "\"Do it now!\"", nextScene: 'l4_buck_fail', stats: { prof: 0, emp: -2, pat: -2, reg: 0, assert: 0 }, feedback: "Impatience. Ruined surprise." },
                    { text: "*Scream at the sun*", nextScene: 'l4_buck_success', stats: { prof: 0, emp: 0, pat: 0, reg: 0, assert: 2 }, feedback: "Crazy Cuckoo! Good redirection." },
                    { text: "\"Shhhh.\"", nextScene: 'l4_buck_success', stats: { prof: 1, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Regulation." }
                ]
            },
            l4_buck_success: { id: 'l4_buck_success', bg: 'from-purple-900 to-slate-900', character: 'buck', text: "\"Okay, I'll wait.\"", speaker: "Buck", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_buck_fail: { id: 'l4_buck_fail', bg: 'from-purple-900 to-slate-900', character: 'buck', text: "\"Oops.\"", speaker: "Buck", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_bobby: {
                id: 'l4_bobby',
                bg: 'from-purple-900 to-slate-900',
                character: 'bobby',
                text: "\"Why is everyone acting strange?\"",
                speaker: "Bobby",
                choices: [
                    { text: "\"Just cleaning!\"", nextScene: 'l4_bobby_success', stats: { prof: 0, emp: 1, pat: 1, reg: 1, assert: 0 }, feedback: "White Lie. Protected the secret. (+1 Empathetic)" },
                    { text: "\"WE MADE A CAKE!\"", nextScene: 'l4_bobby_fail', stats: { prof: 0, emp: -2, pat: -2, reg: -1, assert: 0 }, feedback: "Blurted out. Failed to wait. (-2 Empathetic)" },
                    { text: "*Run away screaming*", nextScene: 'l4_bobby_fail', stats: { prof: -3, emp: 0, pat: 0, reg: -2, assert: 2 }, feedback: "Crazy Cuckoo! Suspicious." },
                    { text: "\"I don't know.\"", nextScene: 'l4_bobby_success', stats: { prof: 1, emp: 0, pat: 1, reg: 1, assert: 0 }, feedback: "Playing dumb works." }
                ]
            },
            l4_bobby_success: { id: 'l4_bobby_success', bg: 'from-purple-900 to-slate-900', character: 'bobby', text: "\"Okay...\"", speaker: "Bobby", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },
            l4_bobby_fail: { id: 'l4_bobby_fail', bg: 'from-purple-900 to-slate-900', character: 'bobby', text: "\"A cake? Oh.\"", speaker: "Bobby", choices: [{ text: "Back to Planning", nextScene: 'level4_hub' }] },

            // Level 5
            level5_transition: { id: 'level5_transition', bg: 'from-orange-900 to-black', character: null, text: "Sunset on the Savannah Roof. It's a sad anniversary. Communicating grief.", speaker: "Narrator", choices: [{ text: "*Go to Roof*", nextScene: 'level5_hub' }] },
            level5_hub: {
                id: 'level5_hub',
                bg: 'from-orange-900 to-black',
                character: null,
                text: "CHAPTER 5: The Roof. Be gentle.",
                speaker: "The Roof",
                choices: [
                    { text: "Chimney (Sad)", nextScene: 'l5_chimney', targetChar: 'chimney' },
                    { text: "Athena (Crying)", nextScene: 'l5_athena', targetChar: 'athena' },
                    { text: "End Shift", nextScene: 'end_game', isExit: true }
                ]
            },
            l5_chimney: {
                id: 'l5_chimney',
                bg: 'from-orange-900 to-black',
                character: 'chimney',
                text: "\"I miss Pops. The herd isn't the same without him.\"",
                speaker: "Chimney",
                choices: [
                    { text: "\"I know. It's hard.\"", nextScene: 'l5_chimney_success', stats: { prof: 0, emp: 2, pat: 1, reg: 1, assert: 0 }, feedback: "Validation. Simple words can be powerful." },
                    { text: "\"I lost a friend once too.\"", nextScene: 'l5_chimney_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Relating. Sharing gently helps connection." },
                    { text: "*Howl at the moon*", nextScene: 'l5_chimney_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 2 }, feedback: "Crazy Cuckoo... but spiritual? Rituals can help grief." },
                    { text: "\"Circle of life.\"", nextScene: 'l5_chimney_fail', stats: { prof: 0, emp: -2, pat: 0, reg: 0, assert: 0 }, feedback: "Too clinical. This feels cold in a sad moment. (-2 Empathetic)" }
                ]
            },
            l5_chimney_success: { id: 'l5_chimney_success', bg: 'from-orange-900 to-black', character: 'chimney', text: "\"Yeah. Thanks Ayshe.\"", speaker: "Chimney", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },
            l5_chimney_fail: { id: 'l5_chimney_fail', bg: 'from-orange-900 to-black', character: 'chimney', text: "\"Uh... sure.\"", speaker: "Chimney", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },
            l5_athena: {
                id: 'l5_athena',
                bg: 'from-orange-900 to-black',
                character: 'athena',
                text: "The Lioness is crying silently, holding a picture of Pops.",
                speaker: "Athena",
                choices: [
                    { text: "*Stand silently nearby*", nextScene: 'l5_athena_success', stats: { prof: 1, emp: 2, pat: 2, reg: 1, assert: 0 }, feedback: "Presence. Silence speaks volumes when someone is sad." },
                    { text: "\"Stop crying! Be happy!\"", nextScene: 'l5_athena_fail', stats: { prof: -2, emp: -2, pat: -1, reg: 0, assert: 0 }, feedback: "Toxic Positivity. Don't tell people how to feel." },
                    { text: "\"I fight death!\"", nextScene: 'l5_athena_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 2 }, feedback: "Crazy Cuckoo but supportive. She appreciates the loyalty." },
                    { text: "*Offer a tissue*", nextScene: 'l5_athena_success', stats: { prof: 0, emp: 1, pat: 0, reg: 0, assert: 0 }, feedback: "Helpful act. Practical support." }
                ]
            },
            l5_athena_success: { id: 'l5_athena_success', bg: 'from-orange-900 to-black', character: 'athena', text: "\"Thanks cub.\"", speaker: "Athena", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },
            l5_athena_fail: { id: 'l5_athena_fail', bg: 'from-orange-900 to-black', character: 'athena', text: "She turns away. \"Leave me be.\"", speaker: "Athena", choices: [{ text: "Back to Roof", nextScene: 'level5_hub' }] },

            game_over: { id: 'game_over', bg: 'from-red-900 to-black', character: null, text: "GAME OVER. Your stats dropped too low.", speaker: "System", choices: [{ text: "Retry Chapter", action: 'retry' }, { text: "Restart Shift", nextScene: 'start' }] },
            win_game: { id: 'win_game', bg: 'from-yellow-400 to-orange-500', character: null, text: "Shift Complete!", speaker: "System", choices: [{ text: "Play Again", nextScene: 'start' }] }
        };

        function SocialSimGameV10() {
            const [currentSceneId, setCurrentSceneId] = useState('start');
            const [lastChapterStart, setLastChapterStart] = useState('start');
            const [stats, setStats] = useState({ emp: 5, prof: 5, assert: 5, pat: 5, reg: 5 }); // 5 Stats
            const [feedback, setFeedback] = useState(null);
            const [visited, setVisited] = useState(new Set());
            const [scoreAnimations, setScoreAnimations] = useState([]);
            const [shaken, setShaken] = useState(false);
            const [currentChoices, setCurrentChoices] = useState([]);
            const [reduceMotion, setReduceMotion] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [winMessage, setWinMessage] = useState("");
            const { speak, stop, isSpeaking } = useTextToSpeech();

            const scene = SCENES[currentSceneId];

            // Share functionality
            const handleShare = () => {
                const subject = encodeURIComponent("My Savanna Squad Score Report");
                const bodyText = `I finished my shift at the Savanna 118!\n\nMy Stats:\n` +
                    `â¤ï¸ Empathetic: ${stats.emp}/10\n` +
                    `ðŸ›¡ï¸ Professional: ${stats.prof}/10\n` +
                    `âš¡ Assertive: ${stats.assert}/10\n` +
                    `â³ Patient: ${stats.pat}/10\n` +
                    `ðŸ“‰ Regulated: ${stats.reg}/10\n\n` +
                    `Can you beat my score?`;
                const body = encodeURIComponent(bodyText);
                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`;
                window.open(gmailLink, '_blank');
            };

            // Transition Logic with Auto-Skip
            const transitionToScene = (targetSceneId) => {
                if (targetSceneId === 'end_game') {
                    // Check if survive (no stats <= 0)
                    const survival = Object.values(stats).every(val => val > 0);
                    if (survival) {
                        // Generate dynamic win message
                        const perfect = Object.values(stats).every(val => val === 10);
                        let msg = "";
                        
                        if (perfect) {
                            msg = "PERFECT SHIFT! You are a master of the Savanna! (10/10 in everything!)";
                        } else {
                            const highs = Object.entries(stats).filter(([k,v]) => v >= 9).map(([k]) => {
                                const map = { emp: 'Empathetic', prof: 'Professional', assert: 'Assertive', pat: 'Patient', reg: 'Regulated' };
                                return map[k];
                            });
                            const lows = Object.entries(stats).filter(([k,v]) => v <= 4).map(([k]) => {
                                const map = { emp: 'Empathetic', prof: 'Professional', assert: 'Assertive', pat: 'Patient', reg: 'Regulated' };
                                return map[k];
                            });
                            
                            msg = "Shift Complete! You survived!";
                            if (highs.length > 0) msg += ` You were super ${highs.join(' & ')}!`;
                            if (lows.length > 0) msg += ` But you can work on being more ${lows.join(' & ')}.`;
                            if (highs.length === 0 && lows.length === 0) msg += " You had a solid, balanced day.";
                        }
                        
                        setWinMessage(msg);
                        setCurrentSceneId('win_game');
                        return;
                    }
                }

                // Check for Auto-Skip in Hubs
                const targetScene = SCENES[targetSceneId];
                if (targetSceneId.includes('hub') && targetScene) {
                    const available = targetScene.choices.filter(c => {
                        if (c.isExit) return true;
                        if (c.action) return true;
                        if (!c.targetChar) return true;
                        return !visited.has(c.targetChar);
                    });

                    // If only exit remains, skip the hub
                    if (available.length === 1 && available[0].isExit) {
                        transitionToScene(available[0].nextScene);
                        return;
                    }
                }
                setCurrentSceneId(targetSceneId);
            };

            // Choice Shuffling
            useEffect(() => {
                if (!scene) return;
                let available = scene.choices.filter(c => {
                    if (c.isExit) return true;
                    if (c.action) return true;
                    if (!c.targetChar) return true;
                    return !visited.has(c.targetChar);
                });

                const exitOption = available.find(c => c.isExit || c.action === 'retry' || c.text === 'Start my shift' || c.text === 'Play Again');
                let others = available.filter(c => c !== exitOption);

                // Fisher-Yates Shuffle
                for (let i = others.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [others[i], others[j]] = [others[j], others[i]];
                }

                if (exitOption) others.push(exitOption);
                
                if (currentSceneId === 'game_over') {
                    setCurrentChoices(scene.choices);
                } else {
                    setCurrentChoices(others);
                }
            }, [currentSceneId, visited, scene]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (feedback) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleFeedbackDismiss();
                        }
                        return;
                    }
                    const keyMap = { '1': 0, '2': 1, '3': 2, '4': 3 };
                    if (keyMap.hasOwnProperty(e.key)) {
                        const index = keyMap[e.key];
                        if (currentChoices[index]) handleChoice(currentChoices[index]);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentChoices, feedback]);

            useEffect(() => {
                if (currentSceneId.includes('hub') || currentSceneId === 'start') setLastChapterStart(currentSceneId);
                if (currentSceneId.includes('transition') || currentSceneId === 'start') setVisited(new Set());
            }, [currentSceneId]);

            useEffect(() => {
                if (currentSceneId === 'start') return;
                if (Object.values(stats).some(v => v <= 0) && currentSceneId !== 'game_over') {
                    setCurrentSceneId('game_over');
                    stop();
                }
            }, [stats, currentSceneId]);

            const addScoreAnimation = (statName, val) => {
                if (reduceMotion) return;
                const id = Date.now() + Math.random();
                setScoreAnimations(prev => [...prev, { id, statName, val }]);
                setTimeout(() => setScoreAnimations(prev => prev.filter(a => a.id !== id)), 1000);
            };

            const handleChoice = (choice) => {
                stop();
                if (choice.action === 'retry') {
                    setStats({ emp: 5, prof: 5, assert: 5, pat: 5, reg: 5 });
                    setVisited(new Set());
                    setCurrentSceneId(lastChapterStart);
                    return;
                }
                if (choice.stats) {
                    // Update all 5 stats
                    Object.keys(choice.stats).forEach(key => {
                        if (choice.stats[key] !== 0) addScoreAnimation(key, choice.stats[key]);
                    });

                    setStats(prev => {
                        const newStats = { ...prev };
                        Object.keys(choice.stats).forEach(key => {
                            newStats[key] = Math.max(0, Math.min(10, prev[key] + choice.stats[key]));
                        });
                        return newStats;
                    });

                    if (!reduceMotion) {
                        const isBad = Object.values(choice.stats).some(v => v < 0);
                        const isGood = Object.values(choice.stats).every(v => v >= 0) && Object.values(choice.stats).some(v => v > 0);
                        
                        if (isBad) {
                            setShaken(true);
                            setTimeout(() => setShaken(false), 500);
                        }
                        if (isGood) {
                            window.confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 }, colors: ['#4F46E5', '#EC4899', '#F59E0B'] });
                        }
                    }
                }
                if (choice.targetChar) setVisited(prev => new Set(prev).add(choice.targetChar));
                if (choice.feedback) {
                    setFeedback({ message: choice.feedback, nextScene: choice.nextScene, statChange: choice.stats });
                } else {
                    if (choice.nextScene) transitionToScene(choice.nextScene);
                }
            };

            const handleFeedbackDismiss = () => {
                stop();
                if (feedback) {
                    if (feedback.nextScene) transitionToScene(feedback.nextScene);
                    setFeedback(null);
                }
            };

            const resetGame = () => {
                stop();
                setCurrentSceneId('start');
                setStats({ emp: 5, prof: 5, assert: 5, pat: 5, reg: 5 });
                setFeedback(null);
                setVisited(new Set());
                setWinMessage("");
            };

            const readCurrentScene = () => {
                let textToRead = "";
                if (feedback) {
                    textToRead = `Review. ${feedback.message}. Click continue.`;
                } else {
                    if (scene.speaker === 'Narrator' || scene.speaker.includes('Watering Hole') || scene.speaker.includes('Truck') || scene.speaker.includes('Bunk') || scene.speaker.includes('Roof') || scene.speaker.includes('Planning')) {
                        textToRead = `${scene.text} `;
                    } else {
                        textToRead = `${scene.speaker} says: ${scene.text} `;
                    }
                    currentChoices.forEach((choice, idx) => {
                        textToRead += `Option ${idx + 1}: ${choice.text}. `;
                    });
                }
                speak(textToRead);
            };

            // Stat Bar Component
            const StatBar = ({ label, value, icon, colorClass, barColorClass, statKey }) => (
                <div className="flex flex-col mb-2 relative">
                    {scoreAnimations.filter(a => a.statName === statKey).map(anim => (
                        <div key={anim.id} className={`absolute right-0 -top-4 text-lg font-black ${anim.val > 0 ? 'text-green-400' : 'text-red-500'} animate-float z-50`}>
                            {anim.val > 0 ? '+' : ''}{anim.val}
                        </div>
                    ))}
                    <div className="flex items-center gap-2 mb-1">
                        <Icon path={icon} className={colorClass} size={16} />
                        <span className={`text-[10px] font-bold uppercase tracking-wider ${colorClass}`}>{label}</span>
                        <span className="ml-auto text-xs font-bold text-slate-400">{value}/10</span>
                    </div>
                    <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden shadow-inner border border-slate-700">
                        <div className={`h-full transition-all duration-500 ease-out ${barColorClass} ${value <= 2 ? 'animate-pulse bg-red-500' : ''}`} style={{ width: `${value * 10}%` }} />
                    </div>
                </div>
            );

            return (
                <div className={`min-h-screen flex items-center justify-center p-4 font-sans bg-slate-950 text-slate-100 ${shaken ? 'animate-shake' : ''}`}>
                    {/* Settings */}
                    <div className="fixed top-4 right-4 z-50">
                        <button onClick={() => setShowSettings(!showSettings)} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 text-slate-300 border border-slate-700 shadow-lg">
                            <Icon path={ICONS.Settings} />
                        </button>
                        {showSettings && (
                            <div className="absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-xl shadow-xl p-4 animate-pop origin-top-right">
                                <h4 className="font-bold text-sm mb-3 text-slate-400">Settings</h4>
                                <label className="flex items-center justify-between cursor-pointer">
                                    <span className="text-sm">Calm Mode (No Shake)</span>
                                    <input type="checkbox" checked={reduceMotion} onChange={(e) => setReduceMotion(e.target.checked)} className="accent-indigo-500 w-4 h-4" />
                                </label>
                            </div>
                        )}
                    </div>

                    <div className="relative w-full max-w-6xl bg-slate-900/90 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row h-[750px] border border-slate-800">
                        
                        {/* Sidebar Stats */}
                        <div className="w-full md:w-72 bg-slate-900 border-r border-slate-800 p-6 flex flex-col justify-between z-10">
                            <div>
                                <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-400 mb-2 tracking-tighter">
                                    SAVANNA SQUAD
                                </h1>
                                <div className="flex gap-2 mb-6">
                                    <span className="text-[10px] font-bold bg-indigo-900/50 text-indigo-300 px-2 py-1 rounded border border-indigo-800">v14.0</span>
                                    <span className="text-[10px] font-bold bg-green-900/50 text-green-300 px-2 py-1 rounded border border-green-800">Social Detective</span>
                                </div>
                                
                                <div className="bg-slate-800/50 p-4 rounded-2xl shadow-sm border border-slate-700 mb-4 backdrop-blur-sm relative overflow-hidden">
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-1"><Icon path={ICONS.Star} size={12} /> Skills</h3>
                                    <StatBar label="Empathetic" value={stats.emp} icon={ICONS.Heart} colorClass="text-pink-400" barColorClass="bg-pink-500" statKey="emp" />
                                    <StatBar label="Professional" value={stats.prof} icon={ICONS.Shield} colorClass="text-indigo-400" barColorClass="bg-indigo-500" statKey="prof" />
                                    <StatBar label="Assertive" value={stats.assert} icon={ICONS.Zap} colorClass="text-amber-400" barColorClass="bg-amber-500" statKey="assert" />
                                    <StatBar label="Patient" value={stats.pat} icon={ICONS.Hourglass} colorClass="text-cyan-400" barColorClass="bg-cyan-500" statKey="pat" />
                                    <StatBar label="Regulated" value={stats.reg} icon={ICONS.Activity} colorClass="text-emerald-400" barColorClass="bg-emerald-500" statKey="reg" />
                                    
                                    {Object.values(stats).some(v => v <= 2) && (
                                        <div className="absolute inset-x-0 bottom-0 bg-red-500/20 p-2 text-center text-red-300 text-[10px] font-bold animate-pulse">
                                            <Icon path={ICONS.AlertTriangle} size={10} className="inline mr-1"/> WARNING: LOW STATS
                                        </div>
                                    )}
                                </div>
                            </div>
                            <button onClick={resetGame} className="flex items-center justify-center gap-2 p-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold transition-all hover:scale-[1.02] border border-slate-700 text-sm">
                                <Icon path={ICONS.RefreshCw} size={16} /> Restart Shift
                            </button>
                        </div>

                        {/* Main Stage */}
                        <div className={`flex-1 relative flex flex-col bg-gradient-to-b ${scene?.bg || 'from-slate-900 to-black'} transition-colors duration-1000`}>
                            <div className="flex-1 flex items-end justify-center pb-0 mb-[-20px] px-4 relative overflow-hidden">
                                <div className="absolute inset-0 opacity-10 flex justify-between items-center px-10 pointer-events-none">
                                    <Icon path={ICONS.Shield} size={200} />
                                    <Icon path={ICONS.Heart} size={200} />
                                </div>
                                {currentSceneId === 'game_over' && (
                                    <div className="absolute inset-0 flex items-center justify-center z-10 animate-pop">
                                        <Icon path={ICONS.Skull} size={150} className="text-red-500 opacity-80" />
                                    </div>
                                )}
                                {currentSceneId === 'win_game' && (
                                    <div className="absolute inset-0 flex items-center justify-center z-10 animate-pop">
                                        <Icon path={ICONS.Trophy} size={150} className="text-yellow-400 drop-shadow-lg" />
                                    </div>
                                )}
                                {scene?.character && (
                                    <div className={`w-72 h-72 md:w-96 md:h-96 ${reduceMotion ? '' : 'animate-in slide-in-from-bottom-8 duration-500'}`}>
                                        <SavannaAvatar type={scene.character} />
                                    </div>
                                )}
                            </div>

                            {/* Dialogue/Feedback Area */}
                            <div className="relative z-20 min-h-[320px]">
                                {feedback ? (
                                    <div className="absolute inset-0 bg-slate-900/95 backdrop-blur-xl border-t border-slate-700 p-8 flex flex-col items-center justify-center text-center animate-pop z-30">
                                        <div className="bg-indigo-900/30 p-4 rounded-full text-indigo-400 mb-4 border border-indigo-800">
                                            <Icon path={ICONS.Brain} size={40} />
                                        </div>
                                        <h3 className="text-2xl font-bold text-white mb-2">Review</h3>
                                        <p className="text-slate-300 text-lg mb-6 max-w-lg">{feedback.message}</p>
                                        <button onClick={handleFeedbackDismiss} className="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl transition-all shadow-lg hover:shadow-indigo-500/30 flex items-center gap-2">
                                            Continue (Press Space) <Icon path={ICONS.ArrowRight} />
                                        </button>
                                    </div>
                                ) : (
                                    <div className="h-full bg-slate-900/80 backdrop-blur-xl border-t border-slate-700 p-6 flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                                        {scene?.speaker && scene.speaker !== 'System' && (
                                            <div className="absolute -top-6 left-0 right-0 px-8 flex justify-between items-end">
                                                <div className="bg-gradient-to-r from-pink-600 to-indigo-600 text-white px-6 py-2 rounded-2xl font-bold shadow-lg text-sm tracking-wide border border-indigo-400/30">
                                                    {scene.speaker}
                                                </div>
                                                <button onClick={isSpeaking ? stop : readCurrentScene} className={`p-3 rounded-full shadow-lg transition-all transform hover:scale-105 ${isSpeaking ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-800 text-indigo-400 border border-slate-600'}`} title="Read Aloud">
                                                    <Icon path={isSpeaking ? ICONS.StopCircle : ICONS.Volume2} size={24} />
                                                </button>
                                            </div>
                                        )}
                                        <p className="text-xl md:text-2xl text-slate-100 font-semibold leading-relaxed mt-4 mb-6">{currentSceneId === 'win_game' ? winMessage : scene?.text}</p>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-auto">
                                            {currentChoices.map((choice, idx) => (
                                                <button key={idx} onClick={() => handleChoice(choice)} className="text-left w-full p-4 bg-slate-800 border border-slate-700 hover:border-indigo-500 hover:bg-indigo-900/20 rounded-xl text-slate-200 font-bold transition-all hover:scale-[1.01] active:scale-95 flex items-center group shadow-sm relative overflow-hidden">
                                                    <div className="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-indigo-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                    <span className="w-8 h-8 rounded-lg bg-slate-700 text-slate-400 flex items-center justify-center text-sm mr-3 group-hover:bg-indigo-600 group-hover:text-white transition-colors font-black flex-shrink-0">
                                                        {String.fromCharCode(49 + idx)}
                                                    </span>
                                                    <span className="text-sm">{choice.text}</span>
                                                </button>
                                            ))}
                                        </div>
                                        {(currentSceneId === 'win_game' || currentSceneId === 'game_over') && (
                                            <div className="mt-4 flex justify-center">
                                                <button onClick={handleShare} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-xl flex items-center gap-2 transition-all">
                                                    <Icon path={ICONS.Mail} size={18} /> Share Results
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SocialSimGameV10 />);
    </script>
</body>
</html>