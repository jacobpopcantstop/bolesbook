<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AyBo Phonics Assessment - Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .correct-bg { background-color: rgba(34, 197, 94, 0.95); }
        .incorrect-bg { background-color: rgba(244, 63, 94, 0.95); }
        .button-shadow { box-shadow: 0 10px 0 0 rgba(0,0,0,0.1); }
        .button-shadow:active { transform: translateY(4px); box-shadow: 0 6px 0 0 rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-slate-50 p-2 sm:p-4 lg:p-8 text-slate-900">

    <div id="app" class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-6">
        
        <!-- LEFT: WORD BANK -->
        <div class="lg:col-span-3 space-y-4 order-2 lg:order-1">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-800 p-4 text-white flex items-center gap-2">
                    <i class="fas fa-list text-sm"></i>
                    <h3 class="font-bold text-sm uppercase">Advanced Target Words</h3>
                </div>
                <div id="wordBankList" class="p-3 bg-slate-50 space-y-2 max-h-[200px] lg:max-h-[450px] overflow-y-auto">
                    <!-- Word list generated by JS -->
                </div>
            </div>
            <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 hidden sm:block">
                <h4 class="text-amber-900 font-black text-xs uppercase mb-2">Challenge Mode</h4>
                <p class="text-[11px] text-amber-700 leading-relaxed italic">
                    Focusing on complex blends and multi-syllable patterns.
                </p>
            </div>
        </div>

        <!-- CENTER: ASSESSMENT -->
        <div class="lg:col-span-9 space-y-4 order-1 lg:order-2">
            <div class="bg-white rounded-3xl lg:rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden flex flex-col h-full min-h-[500px] lg:min-h-[600px]">
                
                <!-- Header -->
                <div class="bg-indigo-700 p-4 lg:p-6 text-white flex justify-between items-center">
                    <div class="flex items-center gap-3 lg:gap-4">
                        <div class="bg-white/20 p-2 lg:p-3 rounded-xl lg:rounded-2xl">
                            <i class="fas fa-mountain text-xl lg:text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-lg lg:text-2xl font-black tracking-tight">Expert Level</h1>
                            <p class="text-indigo-100 text-[10px] lg:text-xs font-bold uppercase tracking-widest opacity-80">Advanced Phonics Assessment</p>
                        </div>
                    </div>
                    <div id="trialProgress" class="flex gap-1 lg:gap-1.5">
                        <!-- Progress dots generated by JS -->
                    </div>
                </div>

                <!-- Main Interaction Area -->
                <div id="gameContainer" class="p-4 lg:p-10 flex-1 flex flex-col">
                    
                    <div id="mainDisplay" class="flex-1 flex flex-col items-center justify-center bg-slate-50 rounded-[2rem] lg:rounded-[3rem] border-2 border-slate-100 mb-4 lg:mb-8 relative overflow-hidden min-h-[250px]">
                        <div id="currentWordText" class="text-5xl md:text-7xl lg:text-9xl font-black text-slate-800 mb-6 lg:mb-10 tracking-tighter select-none transition-all text-center px-4">WORD</div>
                        
                        <button onclick="speakWord()" class="bg-slate-900 text-white px-6 py-3 lg:px-8 lg:py-4 rounded-xl lg:rounded-2xl font-black text-base lg:text-lg uppercase flex items-center gap-3 hover:bg-black transition-all shadow-xl active:scale-95">
                            <i class="fas fa-volume-up text-xl lg:text-2xl"></i> Listen
                        </button>

                        <!-- Feedback Overlay -->
                        <div id="feedbackOverlay" class="hidden absolute inset-0 flex flex-col items-center justify-center animate-in fade-in zoom-in duration-200 z-50">
                            <i id="feedbackIcon" class="text-white text-7xl lg:text-9xl mb-4"></i>
                            <h2 id="feedbackTitle" class="text-3xl lg:text-5xl font-black text-white uppercase italic tracking-wider"></h2>
                        </div>
                    </div>

                    <!-- Responsive Yes/No Response Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-6">
                        <button onclick="handleAnswer(true)" class="h-20 sm:h-32 bg-emerald-500 hover:bg-emerald-600 text-white rounded-2xl lg:rounded-[2rem] flex sm:flex-col items-center justify-center gap-3 sm:gap-0 transition-all button-shadow group">
                            <i class="fas fa-check text-2xl lg:text-4xl sm:mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-lg lg:text-xl font-black uppercase tracking-widest">Yes, Correct</span>
                        </button>
                        <button onclick="handleAnswer(false)" class="h-20 sm:h-32 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl lg:rounded-[2rem] flex sm:flex-col items-center justify-center gap-3 sm:gap-0 transition-all button-shadow group">
                            <i class="fas fa-times text-2xl lg:text-4xl sm:mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-lg lg:text-xl font-black uppercase tracking-widest">No, Wrong</span>
                        </button>
                    </div>
                </div>

                <!-- Summary UI -->
                <div id="summaryContainer" class="hidden p-6 lg:p-10 text-center flex-1 flex flex-col items-center justify-center">
                    <div class="relative mb-4 lg:mb-6">
                        <div id="trophyCircle" class="w-24 h-24 lg:w-32 lg:h-32 rounded-full flex items-center justify-center shadow-inner">
                            <i class="fas fa-award text-4xl lg:text-6xl"></i>
                        </div>
                    </div>
                    <h2 class="text-2xl lg:text-4xl font-black text-slate-800 mb-2">Results</h2>
                    <div class="flex flex-col sm:flex-row gap-3 lg:gap-4 mb-6 lg:mb-10">
                        <div class="bg-indigo-50 border-2 border-indigo-100 px-6 py-4 lg:px-10 lg:py-6 rounded-2xl lg:rounded-3xl">
                            <div id="summaryPercent" class="text-4xl lg:text-6xl font-black text-indigo-600 tracking-tighter">0%</div>
                            <div class="text-[10px] lg:text-xs font-black text-indigo-400 uppercase tracking-widest mt-1">Accuracy</div>
                        </div>
                        <div class="bg-slate-50 border-2 border-slate-200 px-6 py-4 lg:px-10 lg:py-6 rounded-2xl lg:rounded-3xl">
                            <div id="summaryRaw" class="text-4xl lg:text-6xl font-black text-slate-700 tracking-tighter">0/12</div>
                            <div class="text-[10px] lg:text-xs font-black text-slate-400 uppercase tracking-widest mt-1">Score</div>
                        </div>
                    </div>
                    <button onclick="startTrial()" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 lg:px-16 lg:py-6 rounded-2xl lg:rounded-[2.5rem] font-black text-xl lg:text-2xl shadow-2xl shadow-indigo-200 transition-all active:scale-95">
                        New Challenge
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'aybo-reading-assessment';

        // More difficult words with complex blends, digraphs, and silent-e
        const CORRECT_WORDS = [
            'strike', 'throne', 'athlete', 'beast', 
            'coach', 'scrape', 'fright', 'sneeze', 
            'praise', 'ground', 'flight', 'bridge'
        ];

        const WRONG_WORDS = [
            'strik', 'thron', 'athletee', 'beest', 
            'coch', 'scraipe', 'frite', 'sneez', 
            'prays', 'grownd', 'flite', 'brig'
        ];

        let state = {
            user: null,
            currentIndex: 0,
            score: 0,
            shuffledTrials: [],
            isFeedbackActive: false
        };

        window.startTrial = () => {
            const poolCorrect = CORRECT_WORDS.map(w => ({ display: w, isCorrect: true }));
            const poolWrong = WRONG_WORDS.map(w => ({ display: w, isCorrect: false }));
            
            // Randomly pick 6 from each to form the 12-word assessment
            state.shuffledTrials = [
                ...poolCorrect.sort(() => Math.random() - 0.5).slice(0, 6),
                ...poolWrong.sort(() => Math.random() - 0.5).slice(0, 6)
            ].sort(() => Math.random() - 0.5);

            state.currentIndex = 0;
            state.score = 0;
            state.isFeedbackActive = false;
            document.getElementById('summaryContainer').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            updateUI();
        };

        window.speakWord = () => {
            const word = state.shuffledTrials[state.currentIndex].display;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.rate = 0.7;
            window.speechSynthesis.speak(utterance);
        };

        window.handleAnswer = async (userSaysCorrect) => {
            if (state.isFeedbackActive) return;
            state.isFeedbackActive = true;
            
            const trial = state.shuffledTrials[state.currentIndex];
            const isUserRight = (userSaysCorrect === trial.isCorrect);
            
            if (isUserRight) state.score++;

            const overlay = document.getElementById('feedbackOverlay');
            const icon = document.getElementById('feedbackIcon');
            const title = document.getElementById('feedbackTitle');

            overlay.classList.remove('hidden', 'correct-bg', 'incorrect-bg');
            overlay.classList.add(isUserRight ? 'correct-bg' : 'incorrect-bg');
            icon.className = isUserRight ? 'fas fa-rocket text-white animate-bounce' : 'fas fa-times-circle text-white';
            title.innerText = isUserRight ? "Brilliant!" : "Keep Trying!";
            
            setTimeout(async () => {
                overlay.classList.add('hidden');
                state.isFeedbackActive = false;
                
                if (state.currentIndex < 11) {
                    state.currentIndex++;
                    updateUI();
                } else {
                    await finishTrial();
                }
            }, 1000);
        };

        const finishTrial = async () => {
            const accuracy = (state.score / 12) * 100;
            const passed = accuracy >= 75;

            if (state.user) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'trials'), {
                        score: state.score,
                        accuracy: accuracy.toFixed(0),
                        timestamp: Date.now(),
                        date: new Date().toLocaleDateString(),
                        difficulty: 'Advanced',
                        passed: passed
                    });
                } catch (e) { console.error("Save error", e); }
            }

            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('summaryContainer').classList.remove('hidden');
            document.getElementById('summaryPercent').innerText = `${accuracy.toFixed(0)}%`;
            document.getElementById('summaryRaw').innerText = `${state.score}/12`;
            document.getElementById('trophyCircle').className = `w-24 h-24 lg:w-32 lg:h-32 rounded-full flex items-center justify-center ${passed ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-300'}`;
        };

        const updateUI = () => {
            const trial = state.shuffledTrials[state.currentIndex];
            document.getElementById('currentWordText').innerText = trial.display;
            
            const progressCont = document.getElementById('trialProgress');
            progressCont.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const dot = document.createElement('div');
                dot.className = `w-2 h-2 lg:w-3 lg:h-3 rounded-full transition-all duration-300 ${i < state.currentIndex ? 'bg-indigo-300' : i === state.currentIndex ? 'bg-white scale-125 shadow-lg' : 'bg-indigo-900/40'}`;
                progressCont.appendChild(dot);
            }

            const bankCont = document.getElementById('wordBankList');
            bankCont.innerHTML = '';
            CORRECT_WORDS.forEach(word => {
                const isCurrentlyShown = word === trial.display;
                const div = document.createElement('div');
                div.className = `p-2 rounded-lg text-sm font-bold border transition-all ${isCurrentlyShown ? 'bg-indigo-600 text-white border-indigo-700 shadow-md translate-x-1' : 'bg-white text-slate-500 border-slate-200'}`;
                div.innerText = word;
                bankCont.appendChild(div);
            });
        };

        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            onAuthStateChanged(auth, u => { state.user = u; });
            startTrial();
        };

        init();
    </script>
</body>
</html>